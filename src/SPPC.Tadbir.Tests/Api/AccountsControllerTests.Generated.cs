// ------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version: 1.0.0.0
//     Template Version: 1.0
//     Generation Date: 2017-02-18 1:18:37 PM
//  
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
// ------------------------------------------------------------------------------

using System;
using System.Net;
using System.Web.Http.Results;
using Moq;
using NUnit.Framework;
using SPPC.Tadbir.NHibernate;
using SPPC.Tadbir.ViewModel.Finance;

namespace SPPC.Tadbir.Web.Api.Controllers.Tests
{
    [TestFixture]
    [Category("WebApi")]
    public partial class AccountsControllerTests : ApiControllerTestBase<AccountsController>
    {
        [OneTimeSetUp]
        public void FixtureSetup()
        {
            _mockRepository = new Mock<IAccountRepository>();
        }

        [SetUp]
        public void Setup()
        {
            _controller = new AccountsController(_mockRepository.Object);
            _existingAccount = new AccountViewModel() { Id = _existingAccountId };
        }

        #region GetAccount (GET: accounts/{accountId}) tests

        [Test]
        public void GetAccount_SpecifiesCorrectRoute()
        {
            // Arrange (Done in setup methods)

            // Act & Assert
            AssertActionRouteEquals("GetAccount", "accounts/{accountId}");
        }

        [Test]
        public void GetAccount_ReturnsNonNullResult()
        {
            // Arrange (Done in setup methods)

            // Act
            var result = _controller.GetAccount(1);

            // Assert
            Assert.That(result, Is.Not.Null);
        }

        [Test]
        public void GetAccount_CallsRepositoryWithAccountId()
        {
            // Arrange
            int accountId = 1;

            // Act
            _controller.GetAccount(accountId);

            // Assert
            _mockRepository.Verify(repo => repo.GetAccount(accountId), Times.Once);
        }

        [Test]
        public void GetAccount_GivenExistingId_ReturnsJsonWithCorrectContentType()
        {
            // Arrange
            _mockRepository.Setup(repo => repo.GetAccount(_existingAccountId))
                .Returns(new AccountViewModel());

            // Act
            var result = _controller.GetAccount(_existingAccountId) as JsonResult<AccountViewModel>;

            // Assert
            Assert.That(result, Is.Not.Null);
        }

        [Test]
        public void GetAccount_GivenNonExistingId_ReturnsNotFound()
        {
            // Arrange
            int nonExistingId = 2;
            _mockRepository.Setup(repo => repo.GetAccount(nonExistingId))
                .Returns((AccountViewModel)null);

            // Act
            var result = _controller.GetAccount(nonExistingId) as NotFoundResult;

            // Assert
            Assert.That(result, Is.Not.Null);
        }

        [Test]
        public void GetAccount_GivenInvalidId_ReturnsNotFound()
        {
            // Arrange
            int invalidId = 0;
            _mockRepository.Setup(repo => repo.GetAccount(It.Is<int>(val => val <= 0)))
                .Returns((AccountViewModel)null);

            // Act
            var result = _controller.GetAccount(invalidId) as NotFoundResult;

            // Assert
            Assert.That(result, Is.Not.Null);
        }

        #endregion

        #region PostNewAccount (POST: accounts) tests

        [Test]
        public void PostNewAccount_SpecifiesCorrectRoute()
        {
            // Arrange (Done in setup methods)

            // Act & Assert
            AssertActionRouteEquals("PostNewAccount", "accounts");
        }

        [Test]
        public void PostNewAccount_ReturnsNonNullResult()
        {
            // Arrange (Done in Setup method)

            // Act
            var result = _controller.PostNewAccount(new AccountViewModel());

            // Assert
            Assert.That(result, Is.Not.Null);
        }

        [Test]
        public void PostNewAccount_GivenValidModel_CallsRepositoryWithModel()
        {
            // Arrange
            var newAccount = new AccountViewModel();

            // Act
            _controller.PostNewAccount(newAccount);

            // Assert
            _mockRepository.Verify(repo => repo.SaveAccount(newAccount), Times.Once);
        }

        [Test]
        public void PostNewAccount_GivenValidModel_ReturnsCreatedStatusCodeResult()
        {
            // Arrange
            var newAccount = new AccountViewModel();

            // Act
            var result = _controller.PostNewAccount(newAccount) as StatusCodeResult;

            // Assert
            Assert.That(result, Is.Not.Null);
            Assert.That(result.StatusCode, Is.EqualTo(HttpStatusCode.Created));
        }

        [Test]
        public void PostNewAccount_GivenNoContent_ReturnsBadRequestWithMessage()
        {
            // Arrange (Done in setup methods)

            // Act
            var result = _controller.PostNewAccount(null) as BadRequestErrorMessageResult;

            // Assert
            Assert.That(result, Is.Not.Null);
        }

        [Test]
        public void PostNewAccount_GivenInvalidModel_ReturnsInvalidModelStateResultWithModelState()
        {
            // Arrange
            var invalidModel = new AccountViewModel();

            // Act
            _controller.ModelState.AddModelError(String.Empty, "Invalid");
            var result = _controller.PostNewAccount(invalidModel) as InvalidModelStateResult;

            // Assert
            Assert.That(result, Is.Not.Null);
            Assert.That(result.ModelState, Is.SameAs(_controller.ModelState));
        }

        #endregion

        #region PutModifiedAccount (PUT: accounts/{accountId}) tests

        [Test]
        public void PutModifiedAccount_SpecifiesCorrectRoute()
        {
            // Arrange (Done in setup methods)

            // Act & Assert
            AssertActionRouteEquals("PutModifiedAccount", "accounts/{accountId}");
        }

        [Test]
        public void PutModifiedAccount_ReturnsNonNullResult()
        {
            // Arrange (Done in setup methods)

            // Act
            var result = _controller.PutModifiedAccount(_existingAccountId, _existingAccount);

            // Assert
            Assert.That(result, Is.Not.Null);
        }

        [Test]
        public void PutModifiedAccount_GivenInvalidId_ReturnsBadRequestWithMessage()
        {
            // Arrange (Done in setup methods)

            // Act
            var result = _controller.PutModifiedAccount(0, _existingAccount) as BadRequestErrorMessageResult;

            // Assert
            Assert.That(result, Is.Not.Null);
        }

        [Test]
        public void PutModifiedAccount_GivenInvalidModelId_ReturnsBadRequestWithMessage()
        {
            // Arrange
            var account = new AccountViewModel() { Id = 0 };

            // Act
            var result = _controller.PutModifiedAccount(1, account) as BadRequestErrorMessageResult;

            // Assert
            Assert.That(result, Is.Not.Null);
        }

        [Test]
        public void PutModifiedAccount_GivenConflictingIdAndModelId_ReturnsBadRequestWithMessage()
        {
            // Arrange
			int conflictingAccountId = 4;

            // Act
            var result = _controller.PutModifiedAccount(conflictingAccountId, _existingAccount) as BadRequestErrorMessageResult;

            // Assert
            Assert.That(result, Is.Not.Null);
        }

        [Test]
        public void PutModifiedAccount_GivenNoContent_ReturnsBadRequestWithMessage()
        {
            // Arrange (Done in setup methods)
            int validId = 1;

            // Act
            var result = _controller.PutModifiedAccount(validId, null) as BadRequestErrorMessageResult;

            // Assert
            Assert.That(result, Is.Not.Null);
        }

        [Test]
        public void PutModifiedAccount_GivenInvalidModel_ReturnsInvalidModelStateResultWithModelState()
        {
            // Arrange
            var invalidModel = new AccountViewModel() { Id = _existingAccountId };

            // Act
            _controller.ModelState.AddModelError(String.Empty, "Invalid");
            var result = _controller.PutModifiedAccount(_existingAccountId, invalidModel) as InvalidModelStateResult;

            // Assert
            Assert.That(result, Is.Not.Null);
            Assert.That(result.ModelState, Is.SameAs(_controller.ModelState));
        }

        [Test]
        public void PutModifiedAccount_CallsRepositoryWithModel()
        {
            // Arrange (Done in setup methods)

            // Act
            _controller.PutModifiedAccount(_existingAccountId, _existingAccount);

            // Assert
            _mockRepository.Verify(repo => repo.SaveAccount(_existingAccount), Times.Once);
        }

        [Test]
        public void PutModifiedAccount_GivenValidIdAndModel_ReturnsOk()
        {
            // Arrange (Done in setup methods)

            // Act
            var result = _controller.PutModifiedAccount(_existingAccountId, _existingAccount) as OkResult;

            // Assert
            Assert.That(result, Is.Not.Null);
        }

        #endregion

        private Mock<IAccountRepository> _mockRepository;
        private AccountViewModel _existingAccount;
        private int _existingAccountId = 1;
    }
}
